# 당신의 첫 번째 서비스 워커

개발자는 일반 사용자에 비해 성능 좋은 데스크톱, 노트북, 모바일 기기를 통해 사이트에 접속한다.
또한, 로컬 서버나 가까이에 있는 개발 서버와의 연결도 안정적이다. 그러나 일반 사용자는 전혀 다른 환경에서 웹 앱을 경험한다.

서비스 워커의 브라우저 지원 여부를 테스트하면 구형브라우저 사용자도 앱을 이용할 수 있고 최신 브라우저 사용자에게도 향상된 경험을 제공할 수 있습니다. 이러한 **점진적 향상은** 프로그레시브 웹 앱 구축의 핵심 방법이다.

register 함수를 호출하면 프로미스가 반환된다. 프로미스가 결과값을 반환하면 서비스 워커가 성공적으로 등록된 것입니다.

```js
if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("/sw.js")
    .then(function (registration) {
      console.log(
        "ServiceWorker registration successful with scope: ",
        registration.scope
      );
    })
    .catch(function (err) {
      console.log("ServiceWorker registration failed: ", err);
    });
}
```

then 구문에 정의된 함수가 호출되고 만일 문제가 있을 경우 catch블록에 정의된 함수가 호출됩니다.

```js
self.addEventListener("fetch", function (event) {
  console.log("Fetch request for:", event.request.url);
});
```

**서비스워커 내의 self는 서비스 워커 자체를 참조한다.**

이 리스너는 모든 fetch 이벤트를 수신한다. 이벤트를 수신하면 등록된 함수를 실행한다.  
이벤트를 수신하면 등록된 함수를 실행한다. 이때, 이벤트 객체가 유일한 인수로 전달된다.  
등록된 함수는 request객체 (fetch이벤트의 속성으로 접근 가능)에 접근해 request의 URL을 콘솔에 출력한다.

페이지를 새로고침하면, 페이지에서 발생한 모든 URL요청이 브라우저 콘솔에 기록된다.

### 서비스 워커의 생명주기

서비스 워커 파일을 변경할 때, 브라우저를 새로고침하더라도 변경 내용이 바로 적용되지는 않는다. 기존 서비스 워커가 여전히 활성화(active)상태이기 때문이다. 새로운 서비스 워커는 기존 서비스 워커가 페이지를 제어하고 있는 동안 대기(waiting) 상태로 남는다.

크롬 브라우저에서 service worker 탭에서 update on reload를 활성화하면 서비스 어커를 변경하고 페이지를 새로 고칠 때마다 서비스 워커가 페이지를 즉시 제어한다.

```js
self.addEventListener("fetch", function (event) {
  if (event.request.url.includes("bootstrap.min.css")) {
    event.respondWith(
      new Response(
        ".hotel-slogan {background: green !important;} nav {display: none}",
        { headers: { "Content-Type": "text/css" } }
      )
    );
  }
});
```

위 코드는 fetch 이벤트를 수신하고 모든 요청의 URL을 검사하여 bootstrap.min.css라는 문자열이 포함되어 있는지 확인합니다. 만약 포함되어 있다면 서비스 워커는 사용자 정의 CSS를 포함하는 새로운 응답을 즉시 생성하고 원격 서버에서 이 파일을 가져오는 대신 새롭게 생성한 응답을 이용해 페이지 요청에 응답합니다.

**결국 서비스 워커를 통해 브라우저 내부에 프록시 서버를 만들 수 있다.**

## 점진적 향상

현대적인 웹 철학의 핵심은 바로 점진적 향상이다.  
점진적 향상이란, 사용자가 경험할 수 있는 만큼의 기능을 제공하는 것을 말한다.  
이는 사용자가 특정 기능을 지원하지 않는 브라우저를 사용하는 경우에도, 작동이 멈추지 않는 사이트를 만들어야 함을 의미한다.

점진적 향상은 웹 앱을 계층화된 방식으로 구축하는 방식으로 생각해 볼 수도 있다.  
우선 기본 컨텐츠, 간단한 HTML링크, 이미지등으로 시작하고 자바스크립트를 사용할 수 있으면 링크를 강화하여 컨텐츠를 비동기적으로 가져오는 레이어를 추가한다.

방금 본 것처럼 서비스 워커는 요청을 가로채어 콘텐츠를 수정하거나 완전히 새로운 응답으로 대체할 수 있다.  
악의적인 제 3자는 이러한 기능을 통해 중간자 공격을 시도할 수 있다. 이를 방지하고 사용자를 보호하기 위해 보안연결 https를 통해 제공되는 페이지만 서비스 워커를 등록할 수 있다.

개발 중에는 호스트 이름을 localhost로 사용하여 보안 연결 없이 서비스 워커를 사용할 수 있다. 그러나 서버에 웹 앱을 배포한 후에는 서비스 워커가 작동할 수 있도록 HTTPS 연결로 서비스를 제공해야한다.

```js
self.addEventListener("fetch", function (event) {
  if (event.request.url.includes("/img/logo.png")) {
    event.respondWith(fetch("/img/logo-flipped.png"));
  }
});
```

위 코드에서는 요청이 감지되면, fetch 명령을 사용해 뒤집어진 대체 로고 URL을 전달해 새로운 요청을 생성한다.  
fetch는 새로운 reponse를 포함하는 프로미스를 반환한다. 이 response를 인자로 Event.respondWith 메서드를 호출하여, 원래 request이벤트에 응답한다.
