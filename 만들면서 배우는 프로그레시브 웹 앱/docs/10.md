# 사용자에게 푸시 알림 보내기

푸시알림을 받는데 동의한 사용자는 원하는 앱의 콘텐츠와 데이터를 적절한 시기에 업데이트 받을 수 있다.

개발자는 푸시 알림을 통해 사용자 경험을 향상시키고 이를 통해 사용자 앱의 사용량을 늘릴 수 있다. 그런 의미에서 푸시알림은 사용자가 앱을 사용하도록 만들고 결과적으로 앱을 성공으로 이끄는 가장 필수적인 요소이다.

사용자에게 알림을 보내는 기능만큼 웹에 추가했을 때 큰 효과가 있는 기능은 별로 없다.

푸시 알림은 PUSH API를 사용하여 전송된 메시지와 Notification API를 사용하여 보여지는 알림의 두가지 기능으로 이루어진다.

## Notification API

Notification API를 사용하면 웹 페이지나 서비스 워커가 시스템 알림을 생성하고 표시할 수 있다.

이러한 알림은 브라우저 밖에 표시되며, 단일 브라우저 윈도우나 탭 컨텍스트 외부에 존재합니다.

알림은 브라우저 윈도우나 탭과는 독립적으로 작동하기 때문에 사용자가 사이트를 떠난 후에도 생성될 수 있습니다.

```js
Notification.requestPermission().then(function (permission) {
  if (permission === "granted") new Notification("hi");
});
```

사용자에게 알림을 표시하기 전에 우선 사용자에게 권한을 요청해야한다.

## Push API

Push API를 사용하면, 앱 사용자는 서버에서 보낸 푸시 메시지를 구독하고, 서버에서는 언제든지 브라우저로 메시지를 전송할 수 있습니다. 푸시 메시지는 서비스 워커에 의해 제어되며, 사용자가 앱을 떠난 후에도 푸시 메시지를 받아 필요한 작업을 할 수 있습니다. 여기서 작업이란 일반적으로 사용자에게 알림을 표시하는 것 입니다.

심지어 몇초에 한번씩 서비스 워커로 메시지를 보내고 서비스 워커가 서버에 사용자의 현재 상태에 관한 데이터를 서버로 다시 전송하는 방식으로 사용자의 행동을 조용히 추적할 수도 있습니다.

PUSH API가 이런 식으로 남용되지 않도록, 모든 푸시 메시지는 중앙 메시징 서버를 통해 전달됩니다. 이 중앙 서버는 브라우저 공급업체에 의해 관리되며 사용자의 구독 정보를 저장하고 있습니다. 중앙 서버는 메시지가 악용되거나 사용자에게 너무 많은 메시지가 전송되지 않도록 방지합니다. 또한 사용자가 메시지를 받을 수 없는 상태에서 미시지를 보낸 경우라도 이후 메시지가 전달될 수 있도록 여러 복잡한 작업을 처리합니다.

먼저 웹페이지는 PUSH API의 subscribe() 메서드를 호출합니다. 메서드가 호출되면 중앙 메시징 서버로 구독 요청이 전달되고, 중앙 서버는 신규 구독 상세 정보를 저장한 후 구독 상세 정보를 페이지로 반환합니다. 구독 상세 정보는 사용자 상세정보를 저장하는 테이블이나 객체 저장소에 함께 저장되는 경우가 많습니다.

앱 서버는 이전에 저장해두었던 구독 세부정보를 가져와서 메시징 서버로 메시지를 전송할 때 사용합니다. 메시징 서버는 이 메시지를 받아 사용자 브라우저로 전달합니다. 마지막으로 사용자 브라우저에 등록된 서비스 워커는 메시지를 수신하여 그 내용을 읽고 무엇을 할지 결정합니다.

푸시알림 프로세스

1. 페이지 사용자에게 알림을 보여주기 위한 권한을 요청하면 사용자가 그 권한을 부여합니다.
2. 페이지가 중앙 메시징 서버에 접속해 신규 구독 생성을 요청합니다.
3. 메시징 서버는 새로운 구독 세부 정보 객체를 응답으로 반환합니다.
4. 페이지는 앱 서버로 구독 세부 내용을 전송합니다.
5. 앱 서버는 다음에 사용하기 위해 구독 세부 정보를 저장합니다.
6. 시간이 흘러 계절이 바뀝니다. 알림을 보낼 필요가 생깁니다.
7. 앱 서버는 구독 세부 정보를 사용해 사용자에게 보낼 메시지를 메시징 서버로 전송합니다.
8. 메시징 서버는 사용자의 브라우저로 메시지를 전달.
9. 서비스 워커의 push 이벤트 리스너가 메시지를 수신.
10. 서비스 워커가 메시지 내용을 기반으로 알림을 표시.
